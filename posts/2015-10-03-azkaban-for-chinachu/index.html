<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns#
article: http://ogp.me/ns/article#
" lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Chinachuの録画後エンコード・CMカットにAzkabanを入れてジョブ実行管理してみる(Azkabanインストール編) | こーのいけのGitHub Pages</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="https://kounoike.github.io/posts/2015-10-03-azkaban-for-chinachu/">
<!--[if lt IE 9]><script src="/assets/js/html5.js"></script><![endif]--><meta name="author" content="KOUNOIKE Yuusuke">
<meta property="og:site_name" content="こーのいけのGitHub Pages">
<meta property="og:title" content="Chinachuの録画後エンコード・CMカットにAzkabanを入れてジョブ実行管理してみる(Azkabanインストール編)">
<meta property="og:url" content="https://kounoike.github.io/posts/2015-10-03-azkaban-for-chinachu/">
<meta property="og:description" content="Azkabanというジョブ管理ツールがあります。
今回はこれを使ってChinachuの録画後にエンコード・CM検出といったジョブを投げて、ジョブ実行管理させてみます。
recordedCommandで直接エンコードした場合には同時実行されてしまうという問題があるので、
Azkabanに並列実行数の制御をやらせてみることが狙いです。なんせ、J2900は30分の番組のエンコードに3時間もかかってしまう">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2015-10-03T20:14:58+09:00">
<meta property="article:tag" content="azkaban">
<meta property="article:tag" content="chinachu">
<meta property="article:tag" content="ubuntu">
</head>
<body>
    <section class="social"><ul>
<li><a href="../../index.html" title="ホーム"><i class="icon-home"></i></a></li>
            <li><a href="../../archive.html" title="文書一覧"><i class="icon-folder-open-alt"></i></a></li>
            <li><a href="../../categories/index.html" title="タグ"><i class="icon-tags"></i></a></li>
            <li><a href="../../rss.xml" title="RSSフィード"><i class="icon-rss"></i></a></li>
            <li><a href="https://kounoike.github.io" title="About me"><i class="icon-user"></i></a></li>
            <li><a href="https://twitter.com/ko_noike" title="My Twitter"><i class="icon-twitter"></i></a></li>
            <li><a href="https://github.com/kounoike" title="My Github"><i class="icon-github"></i></a></li>

        </ul></section><section class="page-content"><div class="content" rel="main">
    <div class="post">
        <h1 class="p-name entry-title" itemprop="headline name">Chinachuの録画後エンコード・CMカットにAzkabanを入れてジョブ実行管理してみる(Azkabanインストール編)</h1>

        <div class="meta">
            <div class="authordate">
                <time class="timeago" datetime="2015-10-03T20:14:58+09:00">2015-10-03 20:14</time>
            
                      |  
        <a href="index.md" id="sourcelink">ソース</a>

            </div>
                    <div itemprop="keywords" class="tags">
        <ul>
        タグ : 
           <li><a class="tag p-category" href="../../categories/azkaban/" rel="tag">azkaban</a></li>
           <li><a class="tag p-category" href="../../categories/chinachu/" rel="tag">chinachu</a></li>
           <li><a class="tag p-category" href="../../categories/ubuntu/" rel="tag">ubuntu</a></li>
        </ul>
</div>

        </div>
        <div class="body">
            <div>
<p><a href="http://azkaban.github.io/">Azkaban</a>というジョブ管理ツールがあります。
今回はこれを使ってChinachuの録画後にエンコード・CM検出といったジョブを投げて、ジョブ実行管理させてみます。
recordedCommandで直接エンコードした場合には同時実行されてしまうという問題があるので、
Azkabanに並列実行数の制御をやらせてみることが狙いです。なんせ、J2900は30分の番組のエンコードに3時間もかかってしまうような
非力なCPUですので、同時実行の制御は非常に重要です。
<!--more--></p>
<h2>Azkaban のインストール</h2>
<p><a href="http://azkaban.github.io/downloads.html">Azkaban ダウンロードページ</a> には 2.5.0 までしか無いですが、
<a href="https://github.com/azkaban/azkaban">GitHub</a> の Releases には 2.7.0 までがあります。
したがって、自前でビルドすることにします。しかし、2.7.0はうまく動かないので、2.6.4をビルドします。</p>
<p>環境はいつもの Ubuntu Server LTS 14.04.3 です。</p>
<h3>事前準備</h3>
<p>Java がいるのでOracle JDKを入れます。Ubuntu への入れ方は適当にぐぐって調べてください。</p>
<ul>
<li>2.6.4のtar.gzをダウンロード</li>
<li>展開＆cd</li>
</ul>
<p>までやったとします。</p>
<h3>Azkaban Solo Server のビルド</h3>
<p>今回は MySQLとかたっていないので、Javaの内蔵DBである H2 DBを使ってみます。
更にWebUI のサーバと実行用サーバの2つが一緒になっている Solo Server というものでやってみます。</p>
<p>ビルドシステムも Ant から Gradle に変わっています。良く分からないのですが、以下の手順でいけるようです。</p>
<h4>ビルド</h4>
<p>soloserver の配布用 tar をビルドします。
なんかpythonジョブのテストに失敗するので、テストをスキップします。</p>
<pre class="code literal-block"><span></span>$ ./gradlew soloserverDistTar -x <span class="nb">test</span>
</pre>


<p>なんか注意が出てますけどとりあえずビルドは出来ました。build/distributionsにazkaban-solo-server-2.6.4.tar.gzが出来ています。</p>
<h3>展開＆テスト実行</h3>
<pre class="code literal-block"><span></span>$ tar zxvf build/distributions/azkaban-solo-server-2.6.4.tar.gz <span class="o">&amp;&amp;</span> sudo cp -R azkaban-solo-server-2.6.4 /opt/azkaban-solo-server
</pre>


<p>念のため設定系は一般ユーザから読めないようにしておきましょう。</p>
<pre class="code literal-block"><span></span>$ chmod og-r /opt/azkaban-solo-server/conf/*
</pre>


<p>テスト実行してみます。</p>
<pre class="code literal-block"><span></span>$ <span class="nb">cd</span> /opt/azkaban-solo-server
$ sudo ./bin/azkaban-solo-start.sh
</pre>


<p>バックグラウンドで色々微妙なログが流れますが、何か起動したっぽいです。</p>
<h3>ufw（ファイアウォール）の設定</h3>
<pre class="code literal-block"><span></span>$ ufw allow 8081/tcp
</pre>


<p>ufwでファイアウォールを管理している場合は8081/tcpを空けます。</p>
<p>ポート8081にブラウザで接続して、何か見えるようでしたら、動作確認できたということで、もうちょっと設定をしていきます。
azkaban-solo-shutdown.shで停止します。</p>
<h2>設定</h2>
<h3>conf/azkaban-users.xml</h3>
<p>てきとーにユーザ・パスワードを設定します。エンコード用にユーザchinachuを追加。</p>
<h3>conf/azkaban.properties</h3>
<p>サーバの名前とタイムゾーンくらいは設定しておきましょう。重要なこととして、並列実行されるジョブを1つだけに制限しておきます。
（executor.flow.threadsとflow.num.job.threadsのどっちが利くかわかってない。後者だけだと同時実行されちゃったので多分前者かな）</p>
<pre class="code literal-block"><span></span># Azkaban Personalization Settings
azkaban.name=pt3rec
azkaban.label=My PT3REC Azkaban
azkaban.color=#FF3601
default.timezone.id=Asia/Tokyo

executor.flow.threads=1

flow.num.job.threads=1
</pre>


<h3>ユーザ</h3>
<p>なんか一般ユーザで実行させるっぽいので適当に作る。</p>
<pre class="code literal-block"><span></span>$ sudo useradd -s /bin/false -d /opt/azkaban-solo-server azkaban
$ sudo chown -R azkaban:azkaban /opt/azkaban-solo-server
</pre>


<h3>/etc/init/azkaban-solo.conf</h3>
<p>```/etc/init/azkaban-solo.conf
description "Azkaban Solo Server"
author "KOUNOIKE Yuusuke <a href="mailto:kounoike.yuusuke@gmail.com">kounoike.yuusuke@gmail.com</a>"</p>
<p>start on runlevel [2345]
stop on runlevel [016]</p>
<p>setuid azkaban
setgid azkaban</p>
<p>chdir /opt/azkaban-solo-server</p>
<p>script
echo $$ &gt; /var/run/azkaban-solo/azkaban-solo.pid</p>
<p>azkaban_dir=/opt/azkaban-solo-server
tmpdir=/tmp</p>
<p>for file in $azkaban_dir/lib/*.jar;
do
  CLASSPATH=$CLASSPATH:$file
done</p>
<p>for file in $azkaban_dir/extlib/*.jar;
do
  CLASSPATH=$CLASSPATH:$file
done</p>
<p>for file in $azkaban_dir/plugins/<em>/</em>.jar;
do
  CLASSPATH=$CLASSPATH:$file
done</p>
<p>if [ "$HADOOP_HOME" != "" ]; then
        echo "Using Hadoop from $HADOOP_HOME"
        CLASSPATH=$CLASSPATH:$HADOOP_HOME/conf:$HADOOP_HOME/*
        JAVA_LIB_PATH="-Djava.library.path=$HADOOP_HOME/lib/native/Linux-amd64-64"
fi</p>
<p>if [ "$HIVE_HOME" != "" ]; then
        echo "Using Hive from $HIVE_HOME"
        CLASSPATH=$CLASSPATH:$HIVE_HOME/conf:$HIVE_HOME/lib/*
fi</p>
<p>echo $azkaban_dir;
echo $CLASSPATH;</p>
<p>executorport=<code>cat $azkaban_dir/conf/azkaban.properties | grep executor.port | cut -d = -f 2</code>
serverpath=/opt/azkaban-solo-server</p>
<p>if [ -z $AZKABAN_OPTS ]; then
  AZKABAN_OPTS=-Xmx3G
fi
AZKABAN_OPTS="$AZKABAN_OPTS -server -Dcom.sun.management.jmxremote -Djava.io.tmpdir=$tmpdir -Dexecutorport=$executorport -Dserverpath=$serverpath"</p>
<p>java $AZKABAN_OPTS -cp $CLASSPATH azkaban.soloserver.AzkabanSingleServer -conf $azkaban_dir/conf &gt;&gt; /var/log/azkaban-solo/azkaban-solo.log 2&gt;&amp;1
end script</p>
<pre class="code literal-block"><span></span>
</pre>


<p>$ sudo mkdir /var/run/azkaban-solo /var/log/azkaban-solo
$ sudo chown azkaban:azkaban /var/run/azkaban-solo /var/log/azkaban-solo
$ sudo initctl reload-configuration
$ sudo start azkaban-solo
```</p>
<p>Upstartよくわかんない。</p>
<p>ジョブ作成編に続く。</p>
</div>
        </div>
                <ul class="pager hidden-print">
<li class="previous">
                <a href="../2015-09-26-hugo-shortcodes-nicovideo/" rel="prev" title="Hugoのshortcodesでnicovideoの埋め込みを簡単にする">一つ前の文書</a>
            </li>
            <li class="next">
                <a href="../2015-10-04-azkaban-for-chinachu-job/" rel="next" title="Chinachuの録画後エンコード・CMカットにAzkabanを入れてジョブ実行管理してみる(ジョブ作成編)">次の文書</a>
            </li>
        </ul>
</div>
                    <footer id="footer"><p>Contents © 2016         <a href="mailto:kounoike.yuusuke@gmail.com">KOUNOIKE Yuusuke</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         </p>
            
        </footer>
</div>
    </section><script src="../../assets/js/all-nocdn.js" type="text/javascript"></script><script type="text/javascript">
            $(function(){
                $('.timeago').timeago();
            });
        </script>
</body>
</html>
