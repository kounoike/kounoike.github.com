<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns#
article: http://ogp.me/ns/article#
" lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>半自動CMカットスクリプトの作成 | こーのいけのGitHub Pages</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/share-button.min.css" rel="stylesheet" type="text/css">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="https://kounoike.github.io/posts/2015-10-19-semiauto-cm-cut/">
<!--[if lt IE 9]><script src="/assets/js/html5.js"></script><![endif]--><meta name="author" content="KOUNOIKE Yuusuke">
<meta property="og:site_name" content="こーのいけのGitHub Pages">
<meta property="og:title" content="半自動CMカットスクリプトの作成">
<meta property="og:url" content="https://kounoike.github.io/posts/2015-10-19-semiauto-cm-cut/">
<meta property="og:description" content="comskip、色々設定を変えながら試したのですがどうやっても安心して任せられる設定にすることは無理だという結論になりました。
かといっていちいち1ファイルずつちまちまとCMカット作業をしたくはありません。comskipである程度は検出できているのですから。
そうなると次は「人間が確認しつつ、楽をする」ようにしたくなります。そこでcomskipの仕組みを考慮しながら、
pythonやらJavasc">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2015-10-19T19:52:20+09:00">
<meta property="article:tag" content="chinachu">
<meta property="article:tag" content="comskip">
<meta property="article:tag" content="ffmpeg">
<meta property="article:tag" content="python">
<meta property="article:tag" content="ubuntu">
</head>
<body>
    <section class="social"><ul>
<li><a href="../../index.html" title="ホーム"><i class="icon-home"></i></a></li>
            <li><a href="../../archive.html" title="文書一覧"><i class="icon-folder-open-alt"></i></a></li>
            <li><a href="../../categories/index.html" title="タグ"><i class="icon-tags"></i></a></li>
            <li><a href="../../rss.xml" title="RSSフィード"><i class="icon-rss"></i></a></li>
            <li><a href="https://kounoike.github.io" title="About me"><i class="icon-user"></i></a></li>
            <li><a href="https://twitter.com/ko_noike" title="My Twitter"><i class="icon-twitter"></i></a></li>
            <li><a href="https://github.com/kounoike" title="My Github"><i class="icon-github"></i></a></li>

        </ul></section><section class="page-content"><div class="content" rel="main">
    <div class="post">
        <h1 class="p-name entry-title" itemprop="headline name">半自動CMカットスクリプトの作成</h1>

        <div class="meta">
            <div class="authordate">
                <time class="timeago" datetime="2015-10-19T19:52:20+09:00">2015-10-19 19:52</time>
            
                      |  
        <a href="index.md" id="sourcelink">ソース</a>

            </div>
                    <div itemprop="keywords" class="tags">
        <ul>
        タグ : 
           <li><a class="tag p-category" href="../../categories/chinachu/" rel="tag">chinachu</a></li>
           <li><a class="tag p-category" href="../../categories/comskip/" rel="tag">comskip</a></li>
           <li><a class="tag p-category" href="../../categories/ffmpeg/" rel="tag">ffmpeg</a></li>
           <li><a class="tag p-category" href="../../categories/python/" rel="tag">python</a></li>
           <li><a class="tag p-category" href="../../categories/ubuntu/" rel="tag">ubuntu</a></li>
        </ul>
</div>

        </div>
        <div class="body">
            <div>
<p>comskip、色々設定を変えながら試したのですがどうやっても安心して任せられる設定にすることは無理だという結論になりました。
かといっていちいち1ファイルずつちまちまとCMカット作業をしたくはありません。comskipである程度は検出できているのですから。
そうなると次は「人間が確認しつつ、楽をする」ようにしたくなります。そこでcomskipの仕組みを考慮しながら、
pythonやらJavascriptやら使ってCMカット環境を構築してみました。
<!--more--></p>
<h2>概要</h2>
<p>TS録画する→comskipで処理する→comskipの<strong>ログ</strong>からブロックを抽出→可視化→目視で確認・修正してカットスクリプトを生成→ffmpegでカット</p>
<p>ポイントはcomskipの最終結果であるCM判定を当てにしないで、ブロック単位で可視化して誤判定の修正をするところでしょうか。
可視化の方法として、エンコードしたMP4に判定結果を埋め込んで閲覧しながら確認できるバージョンと、HTMLでサムネイルを見ながら確認する
バージョンの2通りを作成しました。
ただし、カットスクリプトの生成ができるのはHTMLバージョンだけです。</p>
<h2>事前検討</h2>
<h3>基本アイデア</h3>
<p>まず、comskipをある程度設定してあれば、「ブロックへの分割」まではそこそこ上手くいくことを期待しておきます。
問題なのは、それぞれのブロックをCMか本編かに分類するときに誤判定があって、時に致命的な間違いを犯すことです。</p>
<p>comskipのフレーム→ブロック→CM検出の仕組みを大雑把に図にするとこんな感じです。</p>
<p><img alt="2015-10-19-comskip-block.png" src="../../img/2015-10-19-comskip-block.png"></p>
<p>前半のブロックへの分割が大体detect_methodで指定しているものだと思います。ちなみに、コードを少し追いかけていて
びっくりしたのは、comskipはブロック分割にはロゴの有無を使っていないんですね。ロゴ情報を使うのは後半の、
ブロックを結合したりCM判定したりするところのようです。</p>
<p>繰り返しますが、前半の「ブロックへの分割」までは上手くいっていることを仮定します。ブロック分割に失敗しているような場合は手作業で
どうにかすることにします。</p>
<p>UIとしてはHTMLを適当に使うことにします。
Javascriptも使うことでクライアント側に特別なソフトを用意しなくても良いです。
かつ、HTMLにdata urlでサムネイル画像を埋め込んで1ファイルで完結するようにもできます。
comskipのログは.logを適当に文字列処理で解析すれば良いので、手馴れた言語であるPythonを使うことにします。
TSからのサムネイル抜き出し方法と、判定結果を目視から修正した結果を使ったカット＆結合の方法が課題です。</p>
<h3>技術検討(サムネイル切り出し)</h3>
<p>まず、TSからサムネイルを切り出す方法として考えたのが以下の2通りです。</p>
<ol>
<li>ffmpegのコマンドをたたく</li>
<li>ffmpegのライブラリをラップしたpythonパッケージを使う</li>
</ol>
<p>1.のコマンドをたたくのは何度も何度も呼び出すオーバーヘッドや、一定区間の画像を切り出すときに色々オプション指定が面倒だったりしたので
やめておいて、2.のライブラリを使う方法を考えます。ちなみに、ffmpegコマンドを呼び出すpythonラッパーライブラリもあるようですが、今回は
検討していません。</p>
<ul>
<li><a href="https://code.google.com/p/pyffmpeg/">pyffmpeg@google code</a></li>
<li><a href="https://github.com/mhaller/pyffmpeg">mhaller/pyffmpeg</a></li>
<li><a href="https://github.com/tranx/pyffmpeg">tranx/pyffmpeg</a></li>
<li><a href="https://pypi.python.org/pypi/Avpy/0.1.0">Avpy</a></li>
<li><a href="https://pypi.python.org/pypi/ffms">ffms</a></li>
</ul>
<p>このうち、githubにあるpyffmpegはどちらもgoogle codeのプロジェクトからの移植です。で、どちらも使っているffmpegのAPIが古くて、
ビルドすらできない状態です。がんばってビルドくらいは通るようにしてみたのですが、core dumpするので使い物になりませんでした。
AvpyはAPI不足だったので使えませんでした。最終的にはffmsになりましたが、最初python2で動かそうとしたら色々ハマったので、python3+ffmsが
最終形となりました。</p>
<h3>技術検討（TSカット＆結合）</h3>
<p>最初はWindowsでもLinuxでも動く<a href="http://fixounet.free.fr/avidemux/">Avidemux</a>のtinypyスクリプトを使って処理しようかと考えていました。
しかし、カット＆結合は動くことには動くのですが、音声ストリームを認識しない動画があったりして微妙に苦労するのでやめました。
最終的にはやっぱりffmpegに頼ることにしました。</p>
<p>ちなみに、（最近の？）ffmpegは<a href="https://trac.ffmpeg.org/wiki/Seeking">ドキュメント</a>によると、</p>
<blockquote>
<p>Using -ss as input option together with -c:v copy might not be accurate since ffmpeg is forced to only use/split on i-frames.</p>
</blockquote>
<p>だそうで、適当に指定した時間からでもIフレームで切ってくれるみたいですね。（逆に、正確に指定した時間で切ってくれないとも言う）</p>
<h3>技術検討（その他）</h3>
<p>ffmsのpythonパッケージではnumpy配列でフレームのデータが得られるようなので、画像のPNG/JPEG変換としてPillowを使うことにします。
さらに、HTML出力を見通し良く記述するために、テンプレート処理系として定番のJinja2を使うことにします。
そして、コマンドライン処理を手抜きする個人的イチ推しライブラリの<a href="http://click.pocoo.org/">click</a>も使うことにします。</p>
<h2>準備</h2>
<ul>
<li>録画環境</li>
<li>comskip</li>
<li>ffmpeg（--enable-libfreetypeしてあるもの）</li>
<li>libffms2（Ubuntu14.04だとlibffms2-3、たぶんlibffms2-devも必要）</li>
<li>python3
<strong> numpy
</strong> Pillow
<strong> Jinja2
</strong> click
** ffms(python binding)</li>
</ul>
<p>comskipは<a href="https://github.com/erikkaashoek/Comskip">erikkaashoek/Comskip</a>を使っていますが、別実装でもWine版でもお好きなように。
ffmpegは<a href="https://github.com/erikkaashoek/Comskip">erikkaashoek/Comskip</a>のubuntu trustyのインストール方法にあるppaを使うのが楽です。
python3のパッケージはシステム全体に入れても良いし、virtualenvとかで独立させても良いです。
ffmsのpython bindingは<a href="https://bitbucket.org/spirit/ffms">spirit/ffms</a>から落としてきてpython3 setup.py installします。</p>
<p>ffmsのpython bindingはドキュメントが無くて苦労しましたが、ipython notebookの補完に頼って色々やってるうちになんとか必要な機能は
たたけるようになりました。</p>
<h2>コード（ffmpegでエンコード編）</h2>
<p>まずはTSをMP4にエンコードしつつ、vfオプションで文字を重ねることで「今見てるシーンはCM(or 本編)と検出されている」ことが
分かるようにしましょう。同時にブロック番号・開始・終了時刻も分かるようにして、こんな感じにします。</p>
<p><img alt="2015-10-19-cm" src="../../img/2015-10-19-cm.jpg"></p>
<p>エンコード自体はシェルスクリプトなどでやることにして、pythonでは長い長いフィルタコマンドを生成させます。</p>
<pre class="code literal-block"><span></span><span class="ch">#!/path/to/python3</span>
<span class="c1"># coding: utf-8</span>

<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="k">def</span> <span class="nf">to_timestamp</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">s</span><span class="p">))[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">':'</span><span class="p">,</span> <span class="s1">r'\:'</span><span class="p">)</span>


<span class="nd">@click.command</span><span class="p">()</span>
<span class="nd">@click.argument</span><span class="p">(</span><span class="s1">'logfile'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s2">"r"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">to_ffvf</span><span class="p">(</span><span class="n">logfile</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">logfile</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"Block list after weighing"</span><span class="p">):</span>
            <span class="k">break</span>
    <span class="n">logfile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="n">logfile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

    <span class="n">blocks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">logfile</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">block</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">"no"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">"isCM"</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"--"</span><span class="p">)</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">"fs"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">19</span><span class="p">:</span><span class="mi">26</span><span class="p">])</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">"fe"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">26</span><span class="p">:</span><span class="mi">33</span><span class="p">])</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">"ts"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">33</span><span class="p">:</span><span class="mi">42</span><span class="p">])</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">"te"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">43</span><span class="p">:</span><span class="mi">52</span><span class="p">])</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">"len"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">53</span><span class="p">:</span><span class="mi">62</span><span class="p">])</span>
        <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>

    <span class="n">vfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">to_timestamp</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s2">"ts"</span><span class="p">])</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">to_timestamp</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s2">"te"</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">b</span><span class="p">[</span><span class="s2">"isCM"</span><span class="p">]:</span>
            <span class="n">vf</span> <span class="o">=</span> <span class="s2">"drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#</span><span class="si">%02d</span><span class="s2">[CM]START\:</span><span class="si">%s</span><span class="s2"> END\:</span><span class="si">%s</span><span class="s2">':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,</span><span class="si">%f</span><span class="s2">)*lte(n,</span><span class="si">%f</span><span class="s2">)'"</span> <span class="o">%</span> <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s2">"no"</span><span class="p">],</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="s1">'fs'</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="s1">'fe'</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vf</span> <span class="o">=</span> <span class="s2">"drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#</span><span class="si">%02d</span><span class="s2">[MV]START\:</span><span class="si">%s</span><span class="s2"> END\:</span><span class="si">%s</span><span class="s2">':fontsize=40:fontcolor=limegreen@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=green@0.6:enable='gte(n,</span><span class="si">%f</span><span class="s2">)*lte(n,</span><span class="si">%f</span><span class="s2">)'"</span> <span class="o">%</span> <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s2">"no"</span><span class="p">],</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="s2">"fs"</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="s2">"fe"</span><span class="p">])</span>
        <span class="n">vfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vf</span><span class="p">)</span>
    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">","</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vfs</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">to_ffvf</span><span class="p">()</span>
</pre>


<p>このコマンドをcomskipのログファイルを引数にして呼び出すと、こんな出力が得られます。
<code>:</code>がffmpegのフィルタオプションの分割文字なので、エスケープしているところが注意点でしょうか。</p>
<pre class="code literal-block"><span></span>drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#00[CM]START\:0\:00\:00.500 END\:0\:00\:05.340':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,1.000000)*lte(n,146.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#01[CM]START\:0\:00\:05.370 END\:0\:00\:35.440':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,147.000000)*lte(n,1048.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#02[CM]START\:0\:00\:35.470 END\:0\:00\:50.450':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,1049.000000)*lte(n,1498.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#03[CM]START\:0\:00\:50.480 END\:0\:01\:05.500':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,1499.000000)*lte(n,1949.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#04[CM]START\:0\:01\:05.530 END\:0\:01\:20.480':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,1950.000000)*lte(n,2398.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#05[CM]START\:0\:01\:20.510 END\:0\:01\:35.460':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,2399.000000)*lte(n,2847.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#06[CM]START\:0\:01\:35.500 END\:0\:03\:09.890':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,2848.000000)*lte(n,5677.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#07[CM]START\:0\:03\:09.920 END\:0\:03\:16.530':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,5678.000000)*lte(n,5876.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#08[CM]START\:0\:03\:16.560 END\:0\:03\:30.480':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,5877.000000)*lte(n,6294.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#09[CM]START\:0\:03\:30.510 END\:0\:03\:45.430':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,6295.000000)*lte(n,6742.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#10[CM]START\:0\:03\:45.460 END\:0\:04\:12.850':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,6743.000000)*lte(n,7564.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#11[CM]START\:0\:04\:12.890 END\:0\:04\:15.360':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,7565.000000)*lte(n,7639.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#12[CM]START\:0\:04\:15.390 END\:0\:04\:30.400':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,7640.000000)*lte(n,8090.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#13[CM]START\:0\:04\:30.440 END\:0\:04\:45.450':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,8091.000000)*lte(n,8541.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#14[CM]START\:0\:04\:45.490 END\:0\:05\:00.470':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,8542.000000)*lte(n,8991.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#15[CM]START\:0\:05\:00.500 END\:0\:05\:15.450':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,8992.000000)*lte(n,9440.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#16[CM]START\:0\:05\:15.480 END\:0\:05\:30.500':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,9441.000000)*lte(n,9891.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#17[CM]START\:0\:05\:30.530 END\:0\:05\:35.840':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,9892.000000)*lte(n,10051.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#18[MV]START\:0\:05\:35.870 END\:0\:08\:21.300':fontsize=40:fontcolor=limegreen@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=green@0.6:enable='gte(n,10052.000000)*lte(n,15010.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#19[MV]START\:0\:08\:21.330 END\:0\:11\:32.460':fontsize=40:fontcolor=limegreen@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=green@0.6:enable='gte(n,15011.000000)*lte(n,20739.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#20[MV]START\:0\:11\:32.490 END\:0\:16\:22.180':fontsize=40:fontcolor=limegreen@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=green@0.6:enable='gte(n,20740.000000)*lte(n,29422.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#21[MV]START\:0\:16\:22.210 END\:0\:18\:17.260':fontsize=40:fontcolor=limegreen@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=green@0.6:enable='gte(n,29423.000000)*lte(n,32871.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#22[CM]START\:0\:18\:17.300 END\:0\:18\:32.440':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,32872.000000)*lte(n,33326.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#23[CM]START\:0\:18\:32.480 END\:0\:18\:47.490':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,33327.000000)*lte(n,33777.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#24[CM]START\:0\:18\:47.530 END\:0\:19\:02.410':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,33778.000000)*lte(n,34224.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#25[CM]START\:0\:19\:02.440 END\:0\:19\:17.420':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,34225.000000)*lte(n,34674.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#26[CM]START\:0\:19\:17.460 END\:0\:19\:32.440':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,34675.000000)*lte(n,35124.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#27[CM]START\:0\:19\:32.470 END\:0\:19\:47.450':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,35125.000000)*lte(n,35574.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#28[CM]START\:0\:19\:47.490 END\:0\:20\:17.420':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,35575.000000)*lte(n,36472.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#29[CM]START\:0\:20\:17.450 END\:0\:20\:32.560':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,36473.000000)*lte(n,36926.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#30[MV]START\:0\:20\:32.600 END\:0\:27\:34.690':fontsize=40:fontcolor=limegreen@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=green@0.6:enable='gte(n,36927.000000)*lte(n,49577.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#31[CM]START\:0\:27\:34.720 END\:0\:29\:04.940':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,49578.000000)*lte(n,52282.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#32[CM]START\:0\:29\:04.980 END\:0\:29\:20.460':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,52283.000000)*lte(n,52747.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#33[CM]START\:0\:29\:20.490 END\:0\:29\:35.470':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,52748.000000)*lte(n,53197.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#34[CM]START\:0\:29\:35.510 END\:0\:29\:50.460':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,53198.000000)*lte(n,53646.000000)',drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf:x=5:y=5:text='#35[CM]START\:0\:29\:50.490 END\:0\:29\:56.230':fontsize=40:fontcolor=magenta@0.4:box=1:boxcolor=white@0.2:borderw=2:bordercolor=red@0.6:enable='gte(n,53647.000000)*lte(n,53820.000000)'
</pre>


<p>この長い長い文字列をffmpegの-vfオプションと共に渡してやって、他の適当なエンコードオプションを指定してエンコードすることによって、動画上でブロック番号・開始・終了時刻・CM/本編(MV)が分かるようになります。</p>
<h2>コード（HTML編）</h2>
<p>上記で作成した動画を見て、「あー、今日は盛大に誤爆ってOPがCMにされてるなー」とか「ブロック分割は大体大丈夫かなー」とアタリを付けたら、次のスクリプトで
生成するHTMLを使って、カット＆結合スクリプトを修正していきます。</p>
<pre class="code literal-block"><span></span><span class="ch">#!/home/chinachu/chinachu-scripts/utils/py3/env3/bin/python</span>
<span class="c1"># coding: utf-8</span>

<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">import</span> <span class="nn">ffms</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">jinja2</span>


<span class="k">def</span> <span class="nf">to_timestamp</span><span class="p">(</span><span class="n">seconds</span><span class="p">):</span>
    <span class="n">td</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">seconds</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">td</span><span class="p">)[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">FFMSVideo</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">videofile</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vs</span> <span class="o">=</span> <span class="n">ffms</span><span class="o">.</span><span class="n">VideoSource</span><span class="p">(</span><span class="n">videofile</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyframes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="o">.</span><span class="n">track</span><span class="o">.</span><span class="n">keyframes</span>

    <span class="k">def</span> <span class="nf">_get_img_by_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">EncodedHeight</span>
        <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">planes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">planes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">box</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">EncodedWidth</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">EncodedHeight</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_frame_img</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dataurl</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">number</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">number</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">number</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">NumFrames</span><span class="p">:</span>
            <span class="n">number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">NumFrames</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="o">.</span><span class="n">get_frame</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ffms</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">"number: </span><span class="si">%d</span><span class="s2">"</span> <span class="o">%</span> <span class="n">number</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">err</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_img_by_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">scale</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">dataurl</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
            <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">"PNG"</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">'data:img/png;base64,'</span> <span class="o">+</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">img</span>

    <span class="k">def</span> <span class="nf">get_near_keyframes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframes</span> <span class="k">if</span> <span class="n">frame</span> <span class="o">-</span> <span class="n">delta</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">frame</span> <span class="o">+</span> <span class="n">delta</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_pts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="o">.</span><span class="n">track</span><span class="o">.</span><span class="n">frame_info_list</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">PTS</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="o">.</span><span class="n">track</span><span class="o">.</span><span class="n">frame_info_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">PTS</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="o">.</span><span class="n">track</span><span class="o">.</span><span class="n">time_base</span><span class="o">.</span><span class="n">Num</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="o">.</span><span class="n">track</span><span class="o">.</span><span class="n">time_base</span><span class="o">.</span><span class="n">Den</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ComSkipResult</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">videofile</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">videofile</span><span class="p">):</span>
            <span class="k">raise</span> <span class="s2">"videofile: </span><span class="si">%s</span><span class="s2"> not found"</span> <span class="o">%</span> <span class="n">videofile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video</span> <span class="o">=</span> <span class="n">FFMSVideo</span><span class="p">(</span><span class="n">videofile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">videofile</span> <span class="o">=</span> <span class="n">videofile</span>
        <span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">videofile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basename</span> <span class="o">=</span> <span class="n">basename</span>
        <span class="n">log</span> <span class="o">=</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">.log"</span> <span class="o">%</span> <span class="n">basename</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">log</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"Block list after weighing"</span><span class="p">):</span>
                        <span class="k">break</span>
                <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">block</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">block</span><span class="p">[</span><span class="s2">"no"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
                    <span class="n">block</span><span class="p">[</span><span class="s2">"isCM"</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"--"</span><span class="p">)</span>
                    <span class="n">block</span><span class="p">[</span><span class="s2">"sbf"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">11</span><span class="p">])</span>
                    <span class="n">block</span><span class="p">[</span><span class="s2">"bs"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="mi">15</span><span class="p">])</span>
                    <span class="n">block</span><span class="p">[</span><span class="s2">"be"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">15</span><span class="p">:</span><span class="mi">19</span><span class="p">])</span>
                    <span class="n">block</span><span class="p">[</span><span class="s2">"fs"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">19</span><span class="p">:</span><span class="mi">26</span><span class="p">])</span>
                    <span class="n">block</span><span class="p">[</span><span class="s2">"fe"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">26</span><span class="p">:</span><span class="mi">33</span><span class="p">])</span>
                    <span class="n">block</span><span class="p">[</span><span class="s2">"ts"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">33</span><span class="p">:</span><span class="mi">42</span><span class="p">])</span>
                    <span class="n">block</span><span class="p">[</span><span class="s2">"te"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">43</span><span class="p">:</span><span class="mi">52</span><span class="p">])</span>
                    <span class="n">block</span><span class="p">[</span><span class="s2">"len"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">53</span><span class="p">:</span><span class="mi">62</span><span class="p">])</span>
                    <span class="n">block</span><span class="p">[</span><span class="s2">"sc"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">63</span><span class="p">:</span><span class="mi">70</span><span class="p">])</span>
                    <span class="n">block</span><span class="p">[</span><span class="s2">"scr"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">70</span><span class="p">:</span><span class="mi">76</span><span class="p">])</span>
                    <span class="n">block</span><span class="p">[</span><span class="s2">"cmb"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">76</span><span class="p">:</span><span class="mi">80</span><span class="p">])</span>
                    <span class="n">block</span><span class="p">[</span><span class="s2">"ar"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">80</span><span class="p">:</span><span class="mi">85</span><span class="p">])</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">96</span><span class="p">:</span><span class="mi">106</span><span class="p">]</span>
                    <span class="n">block</span><span class="p">[</span><span class="s2">"bri"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">107</span><span class="p">:</span><span class="mi">113</span><span class="p">])</span>
                    <span class="n">block</span><span class="p">[</span><span class="s2">"bricode"</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">113</span><span class="p">]</span>
                    <span class="n">block</span><span class="p">[</span><span class="s2">"logo"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">115</span><span class="p">:</span><span class="mi">119</span><span class="p">])</span>
                    <span class="n">block</span><span class="p">[</span><span class="s2">"vol"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">120</span><span class="p">:</span><span class="mi">124</span><span class="p">])</span>
                    <span class="n">block</span><span class="p">[</span><span class="s2">"volcode"</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">124</span><span class="p">]</span>
                    <span class="n">block</span><span class="p">[</span><span class="s2">"sil"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">125</span><span class="p">:</span><span class="mi">128</span><span class="p">])</span>
                    <span class="n">block</span><span class="p">[</span><span class="s2">"silcode"</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">128</span><span class="p">]</span>
                    <span class="n">block</span><span class="p">[</span><span class="s2">"corr"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">130</span><span class="p">:</span><span class="mi">136</span><span class="p">])</span>
                    <span class="n">block</span><span class="p">[</span><span class="s2">"stdev"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">137</span><span class="p">:</span><span class="mi">142</span><span class="p">])</span>
                    <span class="n">block</span><span class="p">[</span><span class="s2">"cc"</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">143</span><span class="p">:]</span>
                    <span class="n">block</span><span class="p">[</span><span class="s2">"line"</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>

                    <span class="n">cutreason</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"F"</span><span class="p">:</span> <span class="s2">"F:scene"</span><span class="p">,</span> <span class="s2">"A"</span><span class="p">:</span> <span class="s2">"A:aspect"</span><span class="p">,</span> <span class="s2">"E"</span><span class="p">:</span> <span class="s2">"E:exceeds"</span><span class="p">,</span> <span class="s2">"L"</span><span class="p">:</span> <span class="s2">"L:logo"</span><span class="p">,</span> <span class="s2">"B"</span><span class="p">:</span> <span class="s2">"B:bright"</span><span class="p">,</span>
                         <span class="s2">"C"</span><span class="p">:</span> <span class="s2">"C:combined"</span><span class="p">,</span> <span class="s2">"N"</span><span class="p">:</span> <span class="s2">"N:nonstrict"</span><span class="p">,</span> <span class="s2">"S"</span><span class="p">:</span> <span class="s2">"S:strict"</span><span class="p">,</span> <span class="s2">"c"</span><span class="p">:</span> <span class="s2">"c:change"</span><span class="p">,</span> <span class="s2">"t"</span><span class="p">:</span> <span class="s2">"t:cutscene"</span><span class="p">,</span>
                         <span class="s2">"l"</span><span class="p">:</span> <span class="s2">"l:logo"</span><span class="p">,</span> <span class="s2">"v"</span><span class="p">:</span> <span class="s2">"v:volume"</span><span class="p">,</span> <span class="s2">"s"</span><span class="p">:</span> <span class="s2">"s:scene_change"</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">:</span> <span class="s2">"a:aspect_ratio"</span><span class="p">,</span>
                         <span class="s2">"u"</span><span class="p">:</span> <span class="s2">"u:uniform_frame"</span><span class="p">,</span> <span class="s2">"b"</span><span class="p">:</span> <span class="s2">"b:black_frame"</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">:</span> <span class="s2">"r:resolution"</span><span class="p">}</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cut</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                            <span class="n">cutreason</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>

                    <span class="n">block</span><span class="p">[</span><span class="s2">"cut"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cutreason</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_html</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tmpl_env</span> <span class="o">=</span> <span class="n">jinja2</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="n">loader</span><span class="o">=</span><span class="n">jinja2</span><span class="o">.</span><span class="n">FileSystemLoader</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">autoescape</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">tmpl</span> <span class="o">=</span> <span class="n">tmpl_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s2">"tmpl.j2"</span><span class="p">)</span>
        <span class="n">tmpl_vars</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"videofile"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">videofile</span><span class="p">,</span> <span class="s2">"comskip"</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span> <span class="s2">"to_timestamp"</span><span class="p">:</span> <span class="n">to_timestamp</span><span class="p">}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s2">".html"</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">tmpl_vars</span><span class="p">))</span>


<span class="nd">@click.command</span><span class="p">()</span>
<span class="nd">@click.argument</span><span class="p">(</span><span class="s1">'videofile'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">to_html</span><span class="p">(</span><span class="n">videofile</span><span class="p">):</span>
    <span class="n">comskip</span> <span class="o">=</span> <span class="n">ComSkipResult</span><span class="p">(</span><span class="n">videofile</span><span class="p">)</span>
    <span class="n">comskip</span><span class="o">.</span><span class="n">to_html</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">to_html</span><span class="p">()</span>
</pre>


<p>HTML生成のために読み込んでいるJinja2テンプレート（tmpl.j2）は以下の通り。</p>
<pre class="code literal-block"><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">"ja"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">"UTF-8"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>{{ videofile }}<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">style</span> <span class="na">type</span><span class="o">=</span><span class="s">"text/css"</span><span class="p">&gt;</span>
<span class="nc">.blocks</span> <span class="p">{</span>
  <span class="nb">border-collapse</span><span class="o">:</span> <span class="nb">collapse</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.blocks</span> <span class="nt">th</span> <span class="p">{</span>
  <span class="nb">padding</span><span class="o">:</span> <span class="m">6px</span><span class="p">;</span>
  <span class="nb">text-align</span><span class="o">:</span> <span class="nb">left</span><span class="p">;</span>
  <span class="nb">color</span><span class="o">:</span> <span class="m">#333</span><span class="p">;</span>
  <span class="nb">background-color</span><span class="o">:</span> <span class="m">#eee</span><span class="p">;</span>
  <span class="nb">border</span><span class="o">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="m">#b9b9b9</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.blocks</span> <span class="nt">td</span> <span class="p">{</span>
  <span class="nb">padding</span><span class="o">:</span> <span class="m">6px</span><span class="p">;</span>
  <span class="nb">text-align</span><span class="o">:</span> <span class="nb">right</span><span class="p">;</span>
  <span class="nb">background-color</span><span class="o">:</span> <span class="m">#fff</span><span class="p">;</span>
  <span class="nb">border</span><span class="o">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="m">#b9b9b9</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.blocks</span> <span class="nt">td</span><span class="nc">.CM</span> <span class="p">{</span>
  <span class="nb">background-color</span><span class="o">:</span> <span class="m">#f0f</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.blocks</span> <span class="nt">td</span><span class="nc">.MV</span> <span class="p">{</span>
  <span class="nb">background-color</span><span class="o">:</span> <span class="m">#0f0</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.props</span> <span class="p">{</span>
  <span class="nb">border-collapse</span><span class="o">:</span> <span class="nb">collapse</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.props</span> <span class="nt">th</span> <span class="p">{</span>
  <span class="nb">background-color</span><span class="o">:</span> <span class="m">#bbf</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">span</span><span class="nc">.changed</span> <span class="p">{</span>
  <span class="nb">text-decoration</span><span class="o">:</span> <span class="nb">line-through</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.thums</span> <span class="p">{</span>
  <span class="nb">border-collapse</span><span class="o">:</span> <span class="nb">collapse</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">textarea</span> <span class="p">{</span>
  <span class="nb">width</span><span class="o">:</span> <span class="m">80%</span><span class="p">;</span>
  <span class="nb">height</span><span class="o">:</span> <span class="m">10em</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"https://code.jquery.com/jquery-1.11.3.min.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">"text/javascript"</span><span class="p">&gt;</span>
<span class="kd">var</span> <span class="nx">blocks</span> <span class="o">=</span> <span class="p">[];</span>
<span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="nx">b</span> <span class="k">in</span> <span class="nx">comskip</span><span class="p">.</span><span class="nx">blocks</span> <span class="o">%</span><span class="p">}</span>
<span class="nx">blocks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="nx">no</span><span class="o">:</span> <span class="p">{{</span> <span class="nx">b</span><span class="p">.</span><span class="nx">no</span> <span class="p">}},</span> <span class="nx">isCM</span><span class="o">:</span> <span class="p">{{</span> <span class="s2">"true"</span> <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">isCM</span> <span class="k">else</span> <span class="s2">"false"</span> <span class="p">}},</span> <span class="nx">fs</span><span class="o">:</span> <span class="p">{{</span> <span class="nx">b</span><span class="p">.</span><span class="nx">fs</span> <span class="p">}},</span> <span class="nx">fe</span><span class="o">:</span> <span class="p">{{</span> <span class="nx">b</span><span class="p">.</span><span class="nx">fe</span> <span class="p">}},</span> <span class="nx">ts</span><span class="o">:</span> <span class="p">{{</span> <span class="nx">b</span><span class="p">.</span><span class="nx">ts</span> <span class="p">}},</span> <span class="nx">te</span><span class="o">:</span> <span class="p">{{</span> <span class="nx">b</span><span class="p">.</span><span class="nx">te</span> <span class="p">}}</span> <span class="p">});</span>
<span class="p">{</span><span class="o">%</span> <span class="nx">endfor</span> <span class="o">%</span><span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">table</span> <span class="na">class</span><span class="o">=</span><span class="s">"blocks"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">thead</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>#<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>CM<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>time/frame<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>scene<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">thead</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">tbody</span><span class="p">&gt;</span>
        {% for b in comskip.blocks %}
            <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{ b.no }}<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">td</span> <span class="na">class</span><span class="o">=</span><span class="s">"{{ "</span><span class="na">CM</span><span class="err">"</span> <span class="na">if</span> <span class="na">b</span><span class="err">.</span><span class="na">isCM</span> <span class="na">else</span> <span class="err">"</span><span class="na">MV</span><span class="err">"</span> <span class="err">}}"</span> <span class="na">id</span><span class="o">=</span><span class="s">"{{ b.no }}"</span><span class="p">&gt;&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">"orig"</span><span class="p">&gt;</span>{{ "CM" if b.isCM else "MV" }}<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;</span><span class="nt">br</span> <span class="p">/&gt;&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">"mod"</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;</span><span class="nt">br</span> <span class="p">/&gt;&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">"changeCM"</span><span class="p">&gt;</span>!!<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>
                    START<span class="p">&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>{{ to_timestamp(b.ts) }}<span class="p">&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>{{ b.fs }}f<span class="p">&lt;</span><span class="nt">br</span> <span class="p">/&gt;&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
                    END<span class="p">&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>{{ to_timestamp(b.te) }}<span class="p">&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>{{ b.fe }}f<span class="p">&lt;</span><span class="nt">br</span> <span class="p">/&gt;&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
                    LENGTH<span class="p">&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>{{ to_timestamp(b.len) }}<span class="p">&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
                <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">td</span> <span class="na">style</span><span class="o">=</span><span class="s">"text-align: left"</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">table</span> <span class="na">class</span><span class="o">=</span><span class="s">"thums"</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
                            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">"{{ comskip.video.get_frame_img(b.fs, scale=1/8, dataurl=True) }}"</span> <span class="p">/&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                            {% for k in comskip.video.get_near_keyframes(b.fs) %}
                                <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">"{{ comskip.video.get_frame_img(k, scale=1/8, dataurl=True) }}"</span> <span class="p">/&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                            {% endfor %}
                        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
                            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"RADIO"</span> <span class="na">class</span><span class="o">=</span><span class="s">"fs"</span> <span class="na">name</span><span class="o">=</span><span class="s">"fs{{b.no}}"</span> <span class="na">value</span><span class="o">=</span><span class="s">"{{b.fs}}"</span> <span class="na">data-no</span><span class="o">=</span><span class="s">"{{b.no}}"</span> <span class="na">data-f</span><span class="o">=</span><span class="s">"{{b.fs}}"</span> <span class="na">data-t</span><span class="o">=</span><span class="s">"{{b.ts}}"</span> <span class="na">checked</span><span class="o">=</span><span class="s">"checked"</span><span class="p">/&gt;</span>
                              {{b.fs}}f,{{ to_timestamp(b.ts) }}
                            <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                            {% for k in comskip.video.get_near_keyframes(b.fs) %}
                            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"RADIO"</span> <span class="na">class</span><span class="o">=</span><span class="s">"fs"</span> <span class="na">name</span><span class="o">=</span><span class="s">"fs{{b.no}}"</span> <span class="na">value</span><span class="o">=</span><span class="s">"{{k}}"</span> <span class="na">data-no</span><span class="o">=</span><span class="s">"{{b.no}}"</span> <span class="na">data-f</span><span class="o">=</span><span class="s">"{{k}}"</span> <span class="na">data-t</span><span class="o">=</span><span class="s">"{{comskip.video.get_pts(k)}}"</span><span class="p">/&gt;</span>
                              {{k}}f,{{ to_timestamp(comskip.video.get_pts(k)) }}
                            <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                            {% endfor %}
                        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
                    <span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">hr</span> <span class="p">/&gt;</span>
                    <span class="p">&lt;</span><span class="nt">table</span> <span class="na">class</span><span class="o">=</span><span class="s">"thums"</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
                            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">"{{ comskip.video.get_frame_img(b.fe, scale=1/8, dataurl=True) }}"</span> <span class="p">/&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                            {% for k in comskip.video.get_near_keyframes(b.fe) %}
                                <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">"{{ comskip.video.get_frame_img(k, scale=1/8, dataurl=True) }}"</span> <span class="p">/&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                            {% endfor %}
                        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
                            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"RADIO"</span> <span class="na">class</span><span class="o">=</span><span class="s">"fe"</span> <span class="na">name</span><span class="o">=</span><span class="s">"fe{{b.no}}"</span> <span class="na">value</span><span class="o">=</span><span class="s">"{{b.fe}}"</span> <span class="na">data-no</span><span class="o">=</span><span class="s">"{{b.no}}"</span> <span class="na">data-f</span><span class="o">=</span><span class="s">"{{b.fe}}"</span> <span class="na">data-t</span><span class="o">=</span><span class="s">"{{b.te}}"</span> <span class="na">checked</span><span class="o">=</span><span class="s">"checked"</span><span class="p">/&gt;</span>
                              {{b.fe}}f,{{ to_timestamp(b.te) }}
                            <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                            {% for k in comskip.video.get_near_keyframes(b.fe) %}
                            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"RADIO"</span> <span class="na">class</span><span class="o">=</span><span class="s">"fe"</span> <span class="na">name</span><span class="o">=</span><span class="s">"fe{{b.no}}"</span> <span class="na">value</span><span class="o">=</span><span class="s">"{{k}}"</span> <span class="na">data-no</span><span class="o">=</span><span class="s">"{{b.no}}"</span> <span class="na">data-f</span><span class="o">=</span><span class="s">"{{k}}"</span> <span class="na">data-t</span><span class="o">=</span><span class="s">"{{comskip.video.get_pts(k)}}"</span><span class="p">/&gt;</span>
                              {{k}}f,{{ to_timestamp(comskip.video.get_pts(k)) }}
                            <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                            {% endfor %}
                        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
                    <span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">table</span> <span class="na">class</span><span class="o">=</span><span class="s">"props"</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="nt">thead</span><span class="p">&gt;</span>
                            <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>sbf<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
                            <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>sc<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
                            <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>scr<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
                            <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>cmb<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
                            <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>ar<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
                            <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>bri<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
                            <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>logo<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
                            <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>stdev<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
                            <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>cut reason<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
                        <span class="p">&lt;/</span><span class="nt">thead</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="nt">tbody</span><span class="p">&gt;</span>
                            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{ b.sbf }}<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{ b.sc }}<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{ b.scr }}<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{ b.cmb }}<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{ b.ar }}<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{ b.bri }}<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{ b.logo }}<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{ b.stdev }}<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{ b.cut }}<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                        <span class="p">&lt;/</span><span class="nt">tbody</span><span class="p">&gt;</span>
                    <span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>
                <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
        {% endfor %}
    <span class="p">&lt;/</span><span class="nt">tbody</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">button</span> <span class="na">id</span><span class="o">=</span><span class="s">"gen"</span><span class="p">&gt;</span>生成<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">textarea</span> <span class="na">id</span><span class="o">=</span><span class="s">"py"</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">textarea</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">textarea</span> <span class="na">id</span><span class="o">=</span><span class="s">"ffmpeg"</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">textarea</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">"text/javascript"</span><span class="p">&gt;</span>
<span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
  <span class="nx">$</span><span class="p">(</span><span class="s2">"button#gen"</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">py</span> <span class="o">=</span> <span class="s2">"#PY\nadm = Avidemux()\neditor = Editor()\nadm.clearSegments()\n"</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">ffmpeg</span> <span class="o">=</span> <span class="s2">"#!/bin/bash\nffmpeg=/usr/bin/ffmpeg\nm2ts='{{ videofile }}'\nbn=${m2ts%.*}\n\n"</span> <span class="o">+</span> <span class="s1">'rm "${bn}.list.txt"\n\n'</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">segments</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">seg_start</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">seg_start_t</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">last_fe</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">last_te</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">blocks</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">seg_start</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">blocks</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s2">"isCM"</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">seg_start</span> <span class="o">=</span> <span class="nx">blocks</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s2">"fs"</span><span class="p">];</span>
        <span class="nx">seg_start_t</span> <span class="o">=</span> <span class="nx">blocks</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s2">"ts"</span><span class="p">];</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">seg_start</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">blocks</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s2">"isCM"</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">segments</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">s</span><span class="o">:</span> <span class="nx">seg_start</span><span class="p">,</span> <span class="nx">e</span><span class="o">:</span> <span class="nx">last_fe</span><span class="p">,</span> <span class="nx">ts</span><span class="o">:</span> <span class="nx">seg_start_t</span><span class="p">,</span> <span class="nx">te</span><span class="o">:</span> <span class="nx">last_te</span><span class="p">});</span>
        <span class="nx">seg_start</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">last_fe</span> <span class="o">=</span> <span class="nx">blocks</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s2">"fe"</span><span class="p">];</span>
      <span class="nx">last_te</span> <span class="o">=</span> <span class="nx">blocks</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s2">"te"</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">seg_start</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">segments</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">s</span><span class="o">:</span> <span class="nx">seg_start</span><span class="p">,</span> <span class="nx">e</span><span class="o">:</span> <span class="nx">last_fe</span><span class="p">,</span> <span class="nx">ts</span><span class="o">:</span> <span class="nx">seg_start_t</span><span class="p">,</span> <span class="nx">te</span><span class="o">:</span> <span class="nx">last_te</span><span class="p">});</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">segments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">segments</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s2">"s"</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">segments</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s2">"e"</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">ts</span> <span class="o">=</span> <span class="nx">segments</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s2">"ts"</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">te</span> <span class="o">=</span> <span class="nx">segments</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s2">"te"</span><span class="p">];</span>
      <span class="nx">py</span> <span class="o">+=</span> <span class="s2">"adm.addSegment(0, editor.getPts("</span> <span class="o">+</span> <span class="nx">s</span> <span class="o">+</span> <span class="s2">"), editor.getPts("</span> <span class="o">+</span> <span class="nx">e</span> <span class="o">+</span> <span class="s2">") - editor.getPts("</span> <span class="o">+</span> <span class="nx">s</span> <span class="o">+</span> <span class="s2">"))\n"</span><span class="p">;</span>
      <span class="nx">ffmpeg</span> <span class="o">+=</span> <span class="s1">'$ffmpeg -i "$m2ts" -ss '</span> <span class="o">+</span> <span class="nx">ts</span> <span class="o">+</span> <span class="s1">' -to '</span> <span class="o">+</span> <span class="nx">te</span> <span class="o">+</span> <span class="s1">' -c:v copy -c:a copy -y "${bn}.chapter'</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">+</span> <span class="s1">'.m2ts"\n'</span><span class="p">;</span>
      <span class="nx">ffmpeg</span> <span class="o">+=</span> <span class="s1">'echo file "\'${bn}.chapter'</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">+</span> <span class="s1">'.m2ts\'" &gt;&gt; "${bn}.list.txt"\n\n'</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">ffmpeg</span> <span class="o">+=</span> <span class="s1">'$ffmpeg -f concat -i "${bn}.list.txt" -c copy "${bn}.nocm.m2ts"\n'</span><span class="p">;</span>

    <span class="nx">$</span><span class="p">(</span><span class="s2">"textarea#py"</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">py</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">"textarea#ffmpeg"</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">ffmpeg</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">$</span><span class="p">(</span><span class="s2">"button.changeCM"</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">td</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">parent</span><span class="p">();</span>
    <span class="nx">td</span><span class="p">.</span><span class="nx">toggleClass</span><span class="p">(</span><span class="s2">"CM"</span><span class="p">);</span>
    <span class="nx">td</span><span class="p">.</span><span class="nx">toggleClass</span><span class="p">(</span><span class="s2">"MV"</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">span_orig</span> <span class="o">=</span> <span class="nx">td</span><span class="p">.</span><span class="nx">children</span><span class="p">(</span><span class="s2">".orig"</span><span class="p">);</span>
    <span class="nx">span_orig</span><span class="p">.</span><span class="nx">toggleClass</span><span class="p">(</span><span class="s2">"changed"</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">span_mod</span> <span class="o">=</span> <span class="nx">td</span><span class="p">.</span><span class="nx">children</span><span class="p">(</span><span class="s2">".mod"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">span_mod</span><span class="p">.</span><span class="nx">text</span><span class="p">()</span> <span class="o">===</span> <span class="s2">""</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">span_orig</span><span class="p">.</span><span class="nx">text</span><span class="p">()</span> <span class="o">===</span> <span class="s2">"CM"</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">span_mod</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s2">"MV"</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">span_mod</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s2">"CM"</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">span_mod</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s2">""</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">idx</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">td</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">"id"</span><span class="p">));</span>
    <span class="nx">blocks</span><span class="p">[</span><span class="nx">idx</span><span class="p">][</span><span class="s2">"isCM"</span><span class="p">]</span> <span class="o">=</span> <span class="o">!</span><span class="nx">blocks</span><span class="p">[</span><span class="nx">idx</span><span class="p">][</span><span class="s2">"isCM"</span><span class="p">];</span>
  <span class="p">});</span>
  <span class="nx">$</span><span class="p">(</span><span class="s2">"input.fs:radio"</span><span class="p">).</span><span class="nx">change</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">idx</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s2">"no"</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s2">"f"</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">ts</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s2">"t"</span><span class="p">);</span>
    <span class="nx">blocks</span><span class="p">[</span><span class="nx">idx</span><span class="p">][</span><span class="s2">"fs"</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">;</span>
    <span class="nx">blocks</span><span class="p">[</span><span class="nx">idx</span><span class="p">][</span><span class="s2">"ts"</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ts</span><span class="p">;</span>
  <span class="p">});</span>
  <span class="nx">$</span><span class="p">(</span><span class="s2">"input.fe:radio"</span><span class="p">).</span><span class="nx">change</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">idx</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s2">"no"</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">fe</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s2">"f"</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">te</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s2">"t"</span><span class="p">);</span>
    <span class="nx">blocks</span><span class="p">[</span><span class="nx">idx</span><span class="p">][</span><span class="s2">"fe"</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fe</span><span class="p">;</span>
    <span class="nx">blocks</span><span class="p">[</span><span class="nx">idx</span><span class="p">][</span><span class="s2">"te"</span><span class="p">]</span> <span class="o">=</span> <span class="nx">te</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">});</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre>


<p>出力されるHTMLには謎の文字列（data url）が埋め込まれているので、ブラウザで開くと以下のような画面が出ます。</p>
<p><img alt="2015-10-19-html" src="../../img/2015-10-19-html.png"></p>
<p>左の「CM」という列がこのブロックがCMとして検出されたことを示しています。「!!」ボタンを押すことでCM/本編を反転させることができます。
ブロック分割が微妙にうまくいってなくて開始/終了がずれてるなー、という場合は、右のラジオボタンから適当なフレームを選択することで
そこを開始/終了にすることもできます。</p>
<p>画面には映っていませんが、下の方に「生成」ボタンがあり、押すとAvidemuxのPYファイル（名残り）とffmpegを呼び出しまくるシェルスクリプト（本命）が
テキストエリアに出力されます。</p>
<p>ファイルシステムに保存したりする機能は無いので、適当にコピペしてやることで、自分で修正したブロックが本編として残ったTSファイルを得ることができます。</p>
</div>
        </div>
        <!-- Social buttons -->
        <share-button></share-button><!-- End of social buttons --><ul class="pager hidden-print">
<li class="previous">
                <a href="../2015-10-04-azkaban-mail/" rel="prev" title="Azkabanでエラーメール">一つ前の文書</a>
            </li>
            <li class="next">
                <a href="../2015-10-24-schedulers/" rel="next" title="スケジューラ色々">次の文書</a>
            </li>
        </ul>
</div>
                    <footer id="footer"><p>Contents © 2017         <a href="mailto:kounoike.yuusuke@gmail.com">KOUNOIKE Yuusuke</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         </p>
            
        </footer>
</div>
    </section><script src="../../assets/js/all-nocdn.js" type="text/javascript"></script><script src="../../assets/js/share-button.min.js" type="text/javascript"></script><script type="text/javascript">
$(function(){
    new ShareButton({
        networks: {
            pinterest: {
                enabled: false
            },
            reddit: {
                enabled: false
            },
            linkedin: {
                enabled: false
            },
            whatsapp: {
                enabled: false
            }
        }
    });
});
</script><script type="text/javascript">
            $(function(){
                $('.timeago').timeago();
            });
        </script>
</body>
</html>
